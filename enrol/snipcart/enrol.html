<?php

$context = context_course::instance($courseid);

$params = array('uid' => $userid,
                'cid' => $courseid,
                'id'  => $instanceid);
$itemurl = str_replace("http://", "https://", new moodle_url("/enrol/snipcart/validate.php", $params));

// Todo: remove after testing =====================================================
$itemurl = str_replace($_SERVER['SERVER_NAME'], gethostbyname($_SERVER['SERVER_NAME']), $itemurl);
// ================================================================================

// Calculate localised and "." cost, make sure we send Snipcart the same value,
// please note Snipcart expects amount with 2 decimal places and "." separator.
$snipcart = new \enrol_snipcart_plugin();
$localisedcost = $snipcart->get_localised_currency($instance->currency, format_float($cost, 2, true));
$cost = format_float($cost, 2, false);

//Sanitise some fields before building the Snipcart code
$coursefullname  = format_string($course->fullname, true, array('context'=>$context));
$courseshortname = format_string($course->shortname, true, array('context' => $context));

?>
<div align="center">

<p><?php print_string("paymentrequired") ?></p>
<p><b><?php echo get_string("cost").": {$instance->currency} $localisedcost"; ?></b></p>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

<script type="text/javascript" src="https://cdn.snipcart.com/scripts/snipcart.js" id="snipcart"
  data-autopop='false'
  data-api-key="<?php echo( $plugin->get_config('publicapikey') ); ?>"></script>

<link type="text/css" href="https://cdn.snipcart.com/themes/base/snipcart.min.css" rel="stylesheet" />

<a href='#'
    class='snipcart-add-item btn btn-primary'
    data-item-id='<?php echo "{$user->id}-{$course->id}-{$instance->id}" ?>'
    data-item-name='<?php p($coursefullname) ?>'
    data-item-price='<?php p($cost) ?>'
    data-item-max-quantity='1'
    data-item-quantity='1'
    data-item-shippable='false'
    data-item-url='<?php echo $itemurl ?>'
    data-item-description='<?php echo $course->summary ?>'>

    <?php print_string('addtocart', 'enrol_snipcart') ?>
</a>

<?php

if ($USER === $user) { 
    $userfullname    = fullname($user);
    $userfirstname   = $user->firstname;
    $userlastname    = $user->lastname;
    $useremail       = $user->email;
    $userphone       = $user->phone1;
    $useraddress     = $user->address;
    $usercity        = $user->city;
    $usercountry     = $user->country;

?>
<script type="text/javascript">
    Snipcart.execute('setBillingAddress', {
    email: '<?php p($useremail) ?>',
    name: '<?php p($userfullname) ?>',
    address1: '<?php p($useraddress) ?>',
    address2: '',
    country: '<?php p($usercountry) ?>',
    province: '',
    city: '<?php p($usercity) ?>',
    phone: '<?php p($userphone) ?>',
    postalCode: ''
});
</script>
<?php } ?>


<div class="snipcart-summary">
    Number of items: <span class="snipcart-total-items"></span>
    Total price: <span class="snipcart-total-price"></span>
</div>

<a href="#" class="snipcart-checkout btn btn-success"><?php print_string('checkout', 'enrol_snipcart') ?></a>

</div>
