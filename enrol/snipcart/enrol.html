<?php

/**
 * Displays interface for purchasing access to the course.
 *
 * @package   enrol_snipcart
 * @author    Tim Butler
 * @copyright (c) 2015 Harcourts International Limited {@link http://www.harcourtsacademy.com}
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
 
defined('MOODLE_INTERNAL') || die();

global $PAGE;
$PAGE->requires->css('/enrol/snipcart/tooltipster/css/tooltipster.css');
$PAGE->requires->css('/enrol/snipcart/tooltipster/css/themes/tooltipster-shadow.css');
$PAGE->requires->js('/enrol/snipcart/tooltipster/js/jquery.tooltipster.min.js');

$context = context_course::instance($course->id);

$params = array('uid' => $userid,
                'eid' => $enrolid);
$itemurl = str_replace("http://", "https://", new moodle_url("/enrol/snipcart/validate.php", $params));

// Calculate localised and "." cost, make sure we send Snipcart the same value,
// please note Snipcart expects amount with 2 decimal places and "." separator.
$plugin = new \enrol_snipcart_plugin();
$localisedcost = $plugin->get_localised_currency($enrol->currency, format_float($cost, 2, true));
$cost = format_float($cost, 2, false);

//Sanitise some fields before building the Snipcart code
$coursefullname  = format_string($course->fullname, true, array('context'=>$context));
$courseshortname = format_string($course->shortname, true, array('context' => $context));

$manager = \enrol_snipcart\get_snipcartaccounts_manager();
$publicapikey = $manager->get_snipcartaccount_info($enrol->currency, 'publicapikey');

// get the first course image
require_once($CFG->libdir. '/coursecatlib.php');
$course = new \course_in_list($course);
$courseoverviewfiles = $course->get_course_overviewfiles();
$firstfile = array_shift($courseoverviewfiles);

$isimage = (!empty($firstfile) and $firstfile->is_valid_image());

if ($isimage) {
    $courseimageurl = file_encode_url("$CFG->wwwroot/pluginfile.php",
            '/'. $firstfile->get_contextid(). '/'. $firstfile->get_component(). '/'.
            $firstfile->get_filearea(). $firstfile->get_filepath(). $firstfile->get_filename(), true);
} else {
    $courseimageurl = new \moodle_url('/enrol/snipcart/pix/empty-course-icon.png');
}

// Generate random tooltip id
$tooltipid = 'tooltip' . mt_rand(1000000, 9999999);

?>
<p class="course-summary"><img src="<?= $courseimageurl ?>" /><?= $course->summary ?></p>
<div align="center">

<p class="payment-required"><?php print_string('paymentrequired', 'enrol_snipcart') ?></p>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

<script type="text/javascript" src="https://cdn.snipcart.com/scripts/snipcart.js" id="snipcart"
  data-autopop='false'
  data-api-key="<?= $publicapikey ?>"></script>

<link type="text/css" href="https://cdn.snipcart.com/themes/base/snipcart.min.css" rel="stylesheet" />

<noscript>
  <div class="alert alert-block alert-error">
      <p><strong><?= get_string('warning', 'moodle') ?></strong> <?= get_string('javascriptrequired', 'group') ?></p>
      <p><?= get_string('nojavascript', 'enrol_snipcart') ?></p>
  </div>
</noscript>

<a href='#' id='<?= $tooltipid ?>' onmousedown='#$("<?= $tooltipid ?>").tooltipster("show")'
    class='snipcart-add-item btn btn-primary'
    style='display: none'
    data-item-id='<?php echo "{$user->id}-{$enrol->id}" ?>'
    data-item-name='<?php p($coursefullname) ?>'
    data-item-price='<?php p($cost) ?>'
    data-item-max-quantity='1'
    data-item-quantity='1'
    data-item-shippable='false'
    data-item-url='<?php echo $itemurl ?>'
    data-item-description='<?php echo $course->summary ?>'
    data-item-image='<?php echo $courseimageurl ?>'>

    <?php print_string('addtocart', 'enrol_snipcart', array('currency'=>$enrol->currency, 'cost'=>$localisedcost)) ?>
</a>

<?php

if ($USER === $user) { 
    $userfullname   = fullname($user);
    $userfirstname  = $user->firstname;
    $userlastname   = $user->lastname;
    $useremail      = trim(preg_replace('/\s*\([^)]*\)/', '', $user->email));
    $userphone      = $user->phone1;
    $useraddress    = $user->address;
    $usercity       = $user->city;
    $usercountry    = $user->country;

    $postcodefieldid    = $DB->get_field('user_info_field', 'id', array( 'shortname' => 'postcode'));
    $postcodefield      = $DB->get_record('user_info_data', array('userid' => $user->id, 'fieldid' => $postcodefieldid));
    $userpostcode       = $postcodefield->data;

?>
<script type="text/javascript">
    window.onload = function() {
        Snipcart.execute('setBillingAddress', {
            email: '<?php p($useremail) ?>',
            name: '<?php p($userfullname) ?>',
            address1: '<?php p($useraddress) ?>',
            address2: '',
            country: '<?php p($usercountry) ?>',
            province: '',
            city: '<?php p($usercity) ?>',
            phone: '<?php p($userphone) ?>',
            postalCode: '<?php p($userpostcode) ?>'
        });
    
        Snipcart.execute('bind', 'order.completed', function (order) {
            var path = location.pathname.substring(0, location.pathname.lastIndexOf("/"));
            var url = path + '/snipcart/completed.php?order=' + order.token + '&eid=<?php p($enrol->id) ?>';
            window.location.href = url;
        });
        
        $('#<?= $tooltipid ?>').tooltipster({
                    animation: 'fade',
                    content: $('<span>Added to shopping cart. <a href="#" class="snipcart-checkout" >View cart</a></span>'),
                    delay: 200,
                    timer: 10000,
                    interactive: true,
                    theme: 'tooltipster-shadow',
                    touchDevices: false,
                    trigger: 'none'
                 });
        $('#<?= $tooltipid ?>')
            .mousedown(function(){
                $(this).tooltipster('show');
             })
            .blur(function(){
                $(this).tooltipster('hide');
            });
        $('.snipcart-add-item').show();
    }

</script>
<?php } ?>

</div>
